const allValues = [
  [
    3984, 3906, 3859, 3780, 3779, 3774, 3773, 3763, 3712, 3707, 3700, 3662,
    3651, 3627, 3624, 3616, 3611, 3610, 3605, 3603, 3601, 3595, 3592, 3590,
    3579, 3579, 3579, 3567, 3560, 3559, 3558, 3557, 3550, 3547, 3547, 3547,
    3546, 3538, 3537, 3534, 3528, 3525, 3520, 3519, 3510,
  ],

  [
    3787, 3769, 3768, 3767, 3758, 3758, 3755, 3748, 3741, 3730, 3705, 3701,
    3664, 3643, 3635, 3628, 3626, 3622, 3620, 3612, 3601, 3600, 3599, 3598,
    3590, 3588, 3586, 3586, 3581, 3579, 3576, 3573, 3565, 3565, 3561, 3558,
    3558, 3553, 3547, 3544, 3544, 3537, 3530, 3529, 3524,
  ],

  [
    3840, 3761, 3753, 3752, 3744, 3743, 3734, 3734, 3732, 3731, 3725, 3696,
    3696, 3695, 3676, 3670, 3663, 3651, 3648, 3642, 3624, 3621, 3620, 3595,
    3586, 3581, 3579, 3570, 3568, 3568, 3566, 3556, 3551, 3549, 3545, 3544,
    3540, 3539, 3534, 3532, 3523, 3511, 3507, 3507, 3507,
  ],

  [
    3808, 3761, 3743, 3728, 3726, 3726, 3725, 3724, 3724, 3721, 3721, 3720,
    3682, 3677, 3668, 3666, 3662, 3634, 3634, 3626, 3620, 3609, 3605, 3604,
    3602, 3599, 3589, 3587, 3583, 3581, 3578, 3569, 3568, 3564, 3560, 3560,
    3546, 3545, 3532, 3531, 3527, 3526, 3523, 3518, 3507,
  ],

  [
    3825, 3822, 3762, 3761, 3717, 3716, 3716, 3714, 3712, 3712, 3711, 3711,
    3709, 3704, 3700, 3672, 3659, 3651, 3640, 3640, 3615, 3609, 3593, 3592,
    3592, 3586, 3578, 3574, 3570, 3567, 3564, 3559, 3558, 3556, 3551, 3550,
    3546, 3536, 3534, 3529, 3528, 3526, 3517, 3515, 3510,
  ],

  [
    3748, 3742, 3738, 3727, 3714, 3713, 3713, 3708, 3708, 3702, 3702, 3689,
    3687, 3685, 3684, 3683, 3658, 3656, 3654, 3632, 3631, 3630, 3629, 3629,
    3622, 3621, 3620, 3609, 3589, 3584, 3577, 3571, 3567, 3565, 3561, 3557,
    3553, 3544, 3526, 3525, 3518, 3514, 3512, 3507, 3505,
  ],

  [
    3780, 3745, 3739, 3730, 3703, 3699, 3697, 3696, 3695, 3691, 3690, 3690,
    3689, 3688, 3679, 3678, 3667, 3655, 3640, 3629, 3622, 3618, 3613, 3612,
    3611, 3607, 3607, 3600, 3577, 3570, 3566, 3564, 3561, 3560, 3558, 3556,
    3556, 3554, 3554, 3551, 3549, 3544, 3543, 3539, 3537,
  ],

  [
    3803, 3704, 3696, 3691, 3689, 3688, 3687, 3687, 3685, 3683, 3683, 3683,
    3672, 3669, 3658, 3652, 3649, 3646, 3646, 3643, 3641, 3639, 3639, 3630,
    3629, 3609, 3607, 3604, 3604, 3603, 3598, 3593, 3587, 3587, 3582, 3569,
    3566, 3566, 3556, 3551, 3536, 3536, 3535, 3523, 3505,
  ],

  [
    3762, 3758, 3736, 3718, 3702, 3689, 3687, 3686, 3681, 3681, 3678, 3677,
    3677, 3674, 3674, 3674, 3665, 3649, 3649, 3645, 3634, 3634, 3630, 3622,
    3617, 3616, 3607, 3604, 3599, 3584, 3580, 3579, 3578, 3577, 3575, 3567,
    3566, 3563, 3561, 3555, 3531, 3527, 3519, 3511, 3510,
  ],

  [
    3725, 3712, 3707, 3701, 3699, 3695, 3693, 3689, 3679, 3676, 3673, 3672,
    3672, 3670, 3668, 3668, 3664, 3661, 3661, 3653, 3647, 3633, 3623, 3620,
    3616, 3614, 3601, 3600, 3600, 3597, 3591, 3591, 3590, 3584, 3584, 3583,
    3579, 3570, 3567, 3564, 3546, 3535, 3517, 3513, 3506,
  ],

  [
    3776, 3736, 3732, 3731, 3730, 3714, 3708, 3706, 3687, 3683, 3671, 3668,
    3664, 3663, 3661, 3660, 3659, 3656, 3646, 3644, 3634, 3630, 3627, 3620,
    3620, 3619, 3609, 3608, 3599, 3586, 3583, 3581, 3580, 3573, 3566, 3563,
    3557, 3552, 3542, 3539, 3539, 3531, 3528, 3517, 3511,
  ],

  [
    3739, 3738, 3719, 3711, 3710, 3685, 3682, 3680, 3666, 3664, 3664, 3663,
    3662, 3661, 3653, 3652, 3652, 3651, 3651, 3650, 3650, 3647, 3646, 3639,
    3637, 3637, 3622, 3616, 3605, 3603, 3603, 3600, 3587, 3587, 3578, 3577,
    3570, 3565, 3559, 3546, 3524, 3523, 3514, 3511, 3510,
  ],

  [
    3760, 3755, 3746, 3728, 3701, 3697, 3696, 3688, 3679, 3670, 3668, 3666,
    3657, 3650, 3650, 3650, 3648, 3647, 3645, 3639, 3639, 3638, 3632, 3627,
    3627, 3624, 3616, 3608, 3598, 3595, 3588, 3588, 3577, 3575, 3569, 3563,
    3562, 3556, 3555, 3555, 3553, 3549, 3529, 3527, 3519,
  ],

  [
    3751, 3740, 3735, 3719, 3714, 3709, 3707, 3706, 3679, 3679, 3676, 3663,
    3657, 3653, 3650, 3644, 3644, 3643, 3643, 3643, 3641, 3634, 3630, 3628,
    3627, 3617, 3606, 3598, 3592, 3591, 3584, 3582, 3582, 3579, 3578, 3576,
    3576, 3567, 3563, 3557, 3547, 3533, 3529, 3521, 3515,
  ],

  [
    3848, 3759, 3753, 3738, 3728, 3720, 3692, 3686, 3683, 3674, 3673, 3657,
    3646, 3644, 3641, 3640, 3637, 3637, 3636, 3636, 3634, 3633, 3628, 3622,
    3622, 3616, 3610, 3606, 3605, 3604, 3600, 3591, 3582, 3571, 3570, 3564,
    3562, 3562, 3554, 3540, 3534, 3531, 3516, 3513, 3511,
  ],

  [
    3824, 3741, 3740, 3733, 3721, 3715, 3710, 3706, 3695, 3682, 3679, 3675,
    3665, 3665, 3664, 3656, 3648, 3641, 3639, 3633, 3630, 3629, 3626, 3625,
    3625, 3619, 3615, 3605, 3592, 3584, 3577, 3573, 3572, 3571, 3569, 3564,
    3556, 3555, 3547, 3540, 3535, 3528, 3527, 3508, 3504,
  ],

  [
    3730, 3727, 3707, 3705, 3703, 3703, 3699, 3697, 3692, 3679, 3660, 3660,
    3655, 3647, 3636, 3635, 3632, 3631, 3629, 3628, 3627, 3626, 3626, 3626,
    3625, 3624, 3620, 3618, 3611, 3608, 3607, 3601, 3594, 3592, 3585, 3584,
    3582, 3579, 3570, 3567, 3554, 3540, 3535, 3530, 3525,
  ],

  [
    3785, 3774, 3774, 3733, 3705, 3695, 3692, 3692, 3690, 3680, 3674, 3654,
    3652, 3645, 3643, 3642, 3642, 3635, 3632, 3626, 3622, 3621, 3620, 3620,
    3619, 3619, 3619, 3618, 3612, 3608, 3594, 3585, 3585, 3580, 3572, 3571,
    3566, 3557, 3554, 3543, 3540, 3540, 3540, 3531, 3508,
  ],

  [
    3769, 3745, 3744, 3740, 3720, 3710, 3701, 3699, 3694, 3686, 3683, 3677,
    3672, 3663, 3654, 3645, 3643, 3643, 3642, 3635, 3634, 3627, 3623, 3616,
    3615, 3615, 3614, 3602, 3599, 3599, 3598, 3589, 3589, 3575, 3570, 3569,
    3559, 3559, 3543, 3539, 3538, 3533, 3522, 3512, 3505,
  ],

  [
    3791, 3732, 3720, 3719, 3718, 3714, 3711, 3702, 3700, 3699, 3695, 3687,
    3673, 3670, 3659, 3643, 3640, 3639, 3631, 3613, 3610, 3609, 3609, 3608,
    3608, 3607, 3607, 3606, 3603, 3601, 3593, 3591, 3586, 3583, 3578, 3577,
    3563, 3560, 3557, 3555, 3542, 3538, 3537, 3516, 3509,
  ],

  [
    3972, 3831, 3747, 3726, 3688, 3683, 3671, 3671, 3670, 3668, 3658, 3655,
    3654, 3649, 3648, 3647, 3646, 3645, 3644, 3640, 3633, 3608, 3604, 3603,
    3602, 3601, 3601, 3600, 3597, 3594, 3591, 3588, 3574, 3573, 3571, 3562,
    3557, 3554, 3553, 3548, 3540, 3540, 3539, 3534, 3529,
  ],

  [
    3903, 3771, 3766, 3759, 3735, 3732, 3730, 3713, 3701, 3680, 3673, 3644,
    3642, 3636, 3625, 3624, 3619, 3616, 3614, 3614, 3608, 3606, 3603, 3601,
    3600, 3599, 3599, 3598, 3597, 3597, 3594, 3593, 3589, 3580, 3576, 3571,
    3569, 3568, 3561, 3552, 3544, 3541, 3528, 3521, 3517,
  ],

  [
    3864, 3825, 3789, 3778, 3762, 3722, 3720, 3705, 3694, 3684, 3682, 3676,
    3671, 3662, 3660, 3646, 3639, 3633, 3631, 3626, 3625, 3620, 3604, 3600,
    3590, 3590, 3589, 3589, 3589, 3584, 3583, 3579, 3571, 3565, 3561, 3560,
    3548, 3547, 3540, 3538, 3523, 3521, 3513, 3505, 3505,
  ],

  [
    3818, 3746, 3737, 3731, 3720, 3719, 3710, 3709, 3705, 3679, 3676, 3664,
    3664, 3657, 3656, 3654, 3629, 3627, 3622, 3619, 3611, 3609, 3609, 3608,
    3607, 3606, 3602, 3595, 3588, 3587, 3586, 3586, 3583, 3583, 3582, 3582,
    3581, 3580, 3576, 3561, 3553, 3537, 3527, 3518, 3509,
  ],

  [
    3955, 3817, 3797, 3782, 3757, 3718, 3698, 3687, 3668, 3654, 3653, 3650,
    3648, 3646, 3643, 3642, 3639, 3630, 3617, 3616, 3613, 3612, 3603, 3602,
    3600, 3590, 3588, 3585, 3579, 3579, 3579, 3579, 3579, 3578, 3578, 3575,
    3563, 3560, 3556, 3549, 3543, 3542, 3529, 3516, 3515,
  ],

  [
    3755, 3717, 3712, 3709, 3708, 3708, 3706, 3705, 3691, 3690, 3689, 3686,
    3685, 3684, 3665, 3665, 3645, 3634, 3627, 3623, 3622, 3620, 3609, 3603,
    3597, 3596, 3593, 3593, 3589, 3582, 3581, 3580, 3576, 3576, 3575, 3574,
    3574, 3574, 3574, 3573, 3573, 3560, 3544, 3533, 3533,
  ],

  [
    3724, 3719, 3713, 3712, 3706, 3701, 3682, 3679, 3669, 3668, 3665, 3661,
    3658, 3656, 3653, 3652, 3645, 3643, 3642, 3637, 3636, 3636, 3635, 3634,
    3627, 3625, 3624, 3621, 3611, 3606, 3584, 3578, 3574, 3571, 3571, 3570,
    3570, 3569, 3568, 3564, 3561, 3560, 3551, 3550, 3528,
  ],

  [
    3759, 3734, 3699, 3694, 3685, 3684, 3681, 3678, 3671, 3670, 3669, 3667,
    3661, 3657, 3651, 3650, 3646, 3644, 3639, 3637, 3637, 3632, 3630, 3630,
    3625, 3619, 3615, 3615, 3614, 3603, 3603, 3602, 3596, 3590, 3583, 3578,
    3570, 3565, 3564, 3561, 3558, 3557, 3541, 3530, 3515,
  ],

  [
    3804, 3785, 3772, 3753, 3739, 3734, 3705, 3703, 3702, 3692, 3690, 3675,
    3666, 3666, 3656, 3652, 3648, 3640, 3636, 3631, 3626, 3623, 3602, 3598,
    3594, 3585, 3585, 3582, 3581, 3580, 3579, 3571, 3566, 3560, 3558, 3558,
    3557, 3556, 3556, 3556, 3553, 3542, 3537, 3531, 3524,
  ],

  [
    3813, 3740, 3731, 3729, 3719, 3714, 3705, 3696, 3695, 3692, 3689, 3665,
    3664, 3657, 3653, 3650, 3650, 3646, 3636, 3631, 3630, 3629, 3620, 3618,
    3617, 3608, 3606, 3600, 3598, 3589, 3585, 3582, 3569, 3567, 3563, 3555,
    3554, 3554, 3554, 3553, 3552, 3549, 3534, 3524, 3524,
  ],

  [
    3904, 3879, 3740, 3738, 3717, 3706, 3693, 3684, 3683, 3681, 3677, 3655,
    3654, 3651, 3649, 3647, 3644, 3643, 3637, 3631, 3620, 3617, 3616, 3615,
    3607, 3607, 3602, 3596, 3596, 3595, 3594, 3577, 3564, 3554, 3552, 3551,
    3546, 3546, 3545, 3544, 3544, 3543, 3534, 3517, 3514,
  ],

  [
    3870, 3854, 3759, 3757, 3745, 3743, 3737, 3736, 3724, 3721, 3703, 3674,
    3663, 3658, 3653, 3648, 3643, 3643, 3638, 3637, 3621, 3611, 3604, 3598,
    3584, 3579, 3573, 3567, 3565, 3565, 3563, 3561, 3559, 3550, 3550, 3547,
    3546, 3542, 3542, 3541, 3541, 3537, 3536, 3515, 3506,
  ],

  [
    3947, 3748, 3742, 3725, 3724, 3716, 3716, 3708, 3695, 3676, 3669, 3668,
    3667, 3659, 3658, 3652, 3645, 3636, 3636, 3635, 3634, 3629, 3629, 3625,
    3615, 3613, 3611, 3608, 3598, 3581, 3572, 3571, 3569, 3564, 3559, 3554,
    3545, 3535, 3532, 3530, 3529, 3527, 3525, 3520, 3511,
  ],

  [
    3803, 3797, 3779, 3771, 3738, 3717, 3713, 3704, 3685, 3676, 3653, 3651,
    3649, 3648, 3648, 3644, 3642, 3634, 3633, 3632, 3631, 3628, 3624, 3624,
    3624, 3623, 3622, 3607, 3594, 3592, 3589, 3584, 3583, 3583, 3577, 3561,
    3559, 3544, 3528, 3525, 3525, 3524, 3518, 3514, 3509,
  ],

  [
    3780, 3762, 3762, 3756, 3756, 3731, 3726, 3724, 3714, 3713, 3710, 3687,
    3684, 3679, 3674, 3673, 3671, 3655, 3654, 3654, 3644, 3644, 3643, 3642,
    3611, 3610, 3593, 3592, 3575, 3572, 3561, 3555, 3552, 3549, 3543, 3536,
    3527, 3525, 3515, 3514, 3512, 3510, 3509, 3505, 3504,
  ],
];

function indexOfMax(arr) {
  if (arr.length === 0) {
    return -1;
  }

  var max = arr[0];
  var maxIndex = 0;

  for (var i = 1; i < arr.length; i++) {
    if (arr[i] > max) {
      maxIndex = i;
      max = arr[i];
    }
  }

  return maxIndex;
}

function indexOfMin(arr) {
  if (arr.length === 0) {
    return -1;
  }

  var min = arr[arr.length - 1];
  var minIndex = arr.length - 1;

  for (var i = arr.length - 2; i >= 0; i--) {
    if (arr[i] < min) {
      minIndex = i;
      min = arr[i];
    }
  }

  return minIndex;
}

function sum(v) {
  return v.reduce((acc, curr) => acc + curr, 0);
}

function getGroupCapacityTargets(values) {
  const totalCapacitySum = sum(values);
  const averageCapacity = totalCapacitySum / values.length;

  const groupCapacityTargets = [
    7 * averageCapacity,
    10 * averageCapacity,
    14 * averageCapacity,
    14 * averageCapacity,
  ];
  return groupCapacityTargets;
}

const result = allValues.reduce<number[][][]>((acc, values, i) => {

  const groupCapacityTargets = getGroupCapacityTargets(values);

  const groups = [
    values.slice(0, 7),
    values.slice(7, 17),
    values.slice(17, 31),
    values.slice(31, 45),
  ];

  for (let step = 0; step < 100; step++) {
    console.log("Group " + i);
    const averages = groups.map((group) => sum(group));

    const differences = averages.map(
      (average, i) => average - groupCapacityTargets[i]
    );
    const plusGroupIndex = indexOfMax(differences);
    const minGroupIndex = indexOfMin(differences);

    const capacityGap = differences[plusGroupIndex] - differences[minGroupIndex];

    let meetStepLarge = 0;
    let meetStepSmall = 0;
    let pickedValueGap = 99999;
    let largeValue = 0;
    let smallValue = 0;
    while (pickedValueGap > capacityGap) {
      largeValue = groups[plusGroupIndex][meetStepLarge];
      smallValue =
        groups[minGroupIndex][groups[minGroupIndex].length - 1 - meetStepSmall];
      pickedValueGap = largeValue - smallValue;

      if (pickedValueGap > capacityGap) {
        if (meetStepLarge <= meetStepSmall) {
          meetStepLarge++;
        } else {
          meetStepSmall++;
        }
      }
    }
    groups[plusGroupIndex].splice(meetStepLarge, 1);
    groups[minGroupIndex].splice(
      groups[minGroupIndex].length - 1 - meetStepSmall,
      1
    );

    const largeInsertIndex = groups[minGroupIndex].reduce((acc, curr, i) => {
      if (curr < largeValue) {
        return acc;
      }
      return i;
    }, 0);

    const smallInsertIndex = groups[plusGroupIndex].reduce((acc, curr, i) => {
      if (curr < smallValue) {
        return acc;
      }
      return i + 1;
    }, 0);

    groups[minGroupIndex].splice(largeInsertIndex, 0, largeValue);
    groups[plusGroupIndex].splice(smallInsertIndex, 0, smallValue);
  }

  acc.push(groups);

  return acc;
}, []);


let csv = '';

for(let layer = 0; layer < result[0].length; layer++) {
  result.forEach((groups, i) => {
    const groupCapacityTargets = getGroupCapacityTargets(allValues[i]);
    const average = sum(groups[layer]);
    const difference = average - groupCapacityTargets[layer];
    csv += `Group ${i} - Layer ${layer} - Cap. target ${groupCapacityTargets[layer]} -  Cap. divergence ${difference} mAh,`;
  });
  csv += '\n';

  for(let i = 0; i < result[0][layer].length; i++) {
    result.forEach((group) => {
      csv += group[layer][i] + ',';
    });
    csv += '\n';
  }

}

console.log(csv);
